#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-0} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

# install nvidia cuda toolkit
#
DIB_NVIDIA_CUDA_TOOLKIT=${DIB_NVIDIA_CUDA_TOOLKIT:-http://192.168.241.198/cuda-toolkit/9.1/cuda-repo-rhel7-9.1.85-1.x86_64.rpm}
wget ${DIB_NVIDIA_CUDA_TOOLKIT}
mv $(basename ${DIB_NVIDIA_CUDA_TOOLKIT}) /opt

cat >> /usr/local/bin/51-custom-cloud-init-once <<DATA

# following code is auto-generated by install.d/93-nvidia-cuda-toolkit
set -e

exec 3> /tmp/custom-cloud-init-once.log
exec 1>&3
exec 2>&3

    rpm -i /opt/$(basename ${DIB_NVIDIA_CUDA_TOOLKIT})
    yum clean all
    yum -y install cuda

exec 3>&-
#rm -f /opt/$(basename ${DIB_NVIDIA_CUDA_TOOLKIT})
DATA
#
