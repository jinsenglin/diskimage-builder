#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-0} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

# install license
#

wget ${DIB_LICENSE_CLIENT_CERT:-http://192.168.240.56.xip.io/client.cert.pem} -O /etc/pki/client.cert.pem
wget ${DIB_LICENSE_CLIENT_KEY:-http://192.168.240.56.xip.io/client.key.pem} -O /etc/pki/client.key.pem
wget ${DIB_LICENSE_VAULT:-http://192.168.240.56.xip.io/src.des3} -O /opt/src.des3

cat >> /usr/local/bin/11-custom-cloud-init-once <<DATA

# following code is auto-generated by install.d/11-license
set -e

exec 3> /var/log/custom-cloud-init-once/11-custom-cloud-init-once.log
exec 1>&3
exec 2>&3

    function suicide() {
        echo TODO: erase files when fails to get serial number from license server.
    }
    trap suicide ERR

    PASS=\$(curl --cert /etc/pki/client.cert.pem --key /etc/pki/client.key.pem --cacert /etc/pki/ca.cert.pem ${DIB_LICENSE_ENDPOINT:-https://192.168.240.56.xip.io/wsgi})
    dd if=/opt/src.des3 | openssl des3 -d -k "\$PASS" | tar zxf - -C /opt
    # mv /opt/src /path/to/target

    echo End

exec 3>&-
DATA

#
