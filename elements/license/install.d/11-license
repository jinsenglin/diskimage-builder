#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-0} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

# install license
#

curl -o /etc/pki/client.cert.pem ${DIB_LICENSE_CLIENT_CERT:-http://192.168.240.56.xip.io/client.cert.pem}
curl -o /etc/pki/client.key.pem ${DIB_LICENSE_CLIENT_KEY:-http://192.168.240.56.xip.io/client.key.pem}
curl -o /opt/safebox.des3 ${DIB_LICENSE_VAULT:-http://192.168.240.56.xip.io/safebox.des3}

cat >> /usr/local/bin/11-custom-cloud-init-once <<DATA

# following code is auto-generated by install.d/11-license
set -e

exec 3> /var/log/custom-cloud-init-once/11-custom-cloud-init-once.log
exec 1>&3
exec 2>&3

    function cleanup() {
        echo Cleaning

        # clean runtime -----------

        # clean puzzles -----------

        # -------------------------

        echo End cleaning
    }
    trap cleanup ERR

    PASS=\$(curl --cert /etc/pki/client.cert.pem --key /etc/pki/client.key.pem --cacert /etc/pki/ca.cert.pem ${DIB_LICENSE_ENDPOINT:-https://192.168.240.56.xip.io/wsgi})
    dd if=/opt/safebox.des3 | openssl des3 -d -k "\$PASS" | tar zxf - -C /opt

    function activate() {
        rm -rf /opt/savebox
    }
    activate

    echo End

exec 3>&-
DATA

#
