#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-0} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

# install license
#

curl -o /etc/pki/client.cert.pem ${DIB_LICENSE_CLIENT_CERT:-http://192.168.240.56.xip.io/client.cert.pem}
curl -o /etc/pki/client.key.pem ${DIB_LICENSE_CLIENT_KEY:-http://192.168.240.56.xip.io/client.key.pem}
curl -o /opt/safebox.des3 ${DIB_LICENSE_VAULT:-http://192.168.240.56.xip.io/safebox.des3}

cat >> /usr/local/bin/11-custom-cloud-init-once <<DATA

# following code is auto-generated by install.d/11-license
set -e

exec 3> /var/log/custom-cloud-init-once/11-custom-cloud-init-once.log
exec 1>&3
exec 2>&3

    function suicide() {
        echo Cleaning

        # clean runtime -----------

        if [ -d /home/grafana ]; then
            rm -rf /home/grafana
        fi

        if [ -f /usr/lib/systemd/system/mariadb.service ]; then
            rm -f /usr/lib/systemd/system/mariadb.service
        fi

        # clean puzzles -----------

        if [ -d /opt/savebox ]; then
            rm -rf /opt/savebox
        fi

        if [ -f /root/cascade-dashboard-dib-ansible ]; then
            rm -rf /root/cascade-dashboard-dib-ansible
        fi

        if [ -f /root/install-sc-dashboard.sh ]; then
            rm -f /root/install-sc-dashboard.sh
        fi

        # -------------------------

        echo End cleaning
    }
    trap suicide ERR

    PASS=\$(curl --cert /etc/pki/client.cert.pem --key /etc/pki/client.key.pem --cacert /etc/pki/ca.cert.pem ${DIB_LICENSE_ENDPOINT:-https://192.168.240.56.xip.io/wsgi})
    dd if=/opt/safebox.des3 | openssl des3 -d -k "\$PASS" | tar zxf - -C /opt
    mv /opt/safebox/cascade-dashboard-dib-ansible /root/
    mv /opt/safebox/install-sc-dashboard.sh /root/
    # mv /opt/safebox/install-sc-engine.sh /root/

    bash /root/install-sc-dashboard.sh
    # bash /root/install-sc-engine.sh

    echo End

exec 3>&-
DATA

#
